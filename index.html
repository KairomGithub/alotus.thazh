<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alotus</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDItUPc2MiD1-Rwm4LXg-yHSQnNt8MBwbE",
      authDomain: "alotus-social.firebaseapp.com",
      projectId: "alotus-social",
      storageBucket: "alotus-social.appspot.com",
      messagingSenderId: "163173869765",
      appId: "1:163173869765:web:12600c0052d725cfe2a8ac"
    };

    // Kh·ªüi t·∫°o Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Hi·ªÉn th·ªã giao di·ªán
    function showRegister() {
      document.getElementById("login-box").style.display = "none";
      document.getElementById("register-box").style.display = "block";
    }

    function showLogin() {
      document.getElementById("register-box").style.display = "none";
      document.getElementById("login-box").style.display = "block";
    }

    // ƒêƒÉng k√Ω t√†i kho·∫£n
    function register() {
      const email = document.getElementById("register-username").value;
      const password = document.getElementById("register-password").value;
      
      createUserWithEmailAndPassword(auth, email, password)
        .then(() => {
          alert("ƒêƒÉng k√Ω th√†nh c√¥ng! H√£y ƒëƒÉng nh·∫≠p.");
          showLogin();
        })
        .catch(error => alert(error.message));
    }

    // ƒêƒÉng nh·∫≠p Email & M·∫≠t kh·∫©u
    function login() {
      const email = document.getElementById("login-username").value;
      const password = document.getElementById("login-password").value;

      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          sessionStorage.setItem("loggedInUser", email);
          showApp(email);
        })
        .catch(() => alert("Sai th√¥ng tin ƒëƒÉng nh·∫≠p!"));
    }

    // ƒêƒÉng nh·∫≠p b·∫±ng Google
    function loginWithGoogle() {
      const provider = new GoogleAuthProvider();
      signInWithPopup(auth, provider)
        .then(result => {
          const user = result.user;
          sessionStorage.setItem("loggedInUser", user.displayName);
          showApp(user.displayName);
        })
        .catch(error => alert("L·ªói ƒëƒÉng nh·∫≠p: " + error.message));
    }

    // Hi·ªÉn th·ªã giao di·ªán ch√≠nh
    function showApp(username) {
      document.getElementById("auth-container").style.display = "none";
      document.getElementById("app-container").style.display = "flex";
      loadPosts();
    }

    // ƒêƒÉng xu·∫•t
    function logout() {
      signOut(auth).then(() => {
        sessionStorage.removeItem("loggedInUser");
        document.getElementById("app-container").style.display = "none";
        document.getElementById("auth-container").style.display = "flex";
      });
    }

    // ƒêƒÉng b√†i vi·∫øt
    async function addPost() {
      const content = document.getElementById("post-content").value;
      const username = sessionStorage.getItem("loggedInUser");

      if (!username || content.trim() === "") {
        alert("Vui l√≤ng nh·∫≠p n·ªôi dung b√†i vi·∫øt!");
        return;
      }

      await addDoc(collection(db, "posts"), {
        username: username,
        content: content,
        likes: [],
        comments: [],
        timestamp: new Date()
      });

      document.getElementById("post-content").value = "";
    }

    // Load b√†i vi·∫øt
    function loadPosts() {
      const feed = document.getElementById("posts");
      feed.innerHTML = "";
      const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));

      onSnapshot(q, snapshot => {
        feed.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const postDiv = document.createElement("div");
          postDiv.classList.add("post");
          postDiv.innerHTML = `
            <p><strong>${data.username}:</strong> ${data.content}</p>
            <button onclick="likePost('${doc.id}')">‚ù§Ô∏è Th√≠ch (${data.likes.length})</button>
            <button onclick="commentPost('${doc.id}')">üí¨ B√¨nh lu·∫≠n</button>
            <button onclick="sharePost('${data.content}')">üîó Chia s·∫ª</button>
            <div id="comments-${doc.id}"></div>
          `;
          feed.appendChild(postDiv);
        });
      });
    }

    // Like b√†i vi·∫øt
    async function likePost(postId) {
      const username = sessionStorage.getItem("loggedInUser");
      const postRef = doc(db, "posts", postId);

      await updateDoc(postRef, {
        likes: arrayUnion(username)
      });
    }

    // B√¨nh lu·∫≠n b√†i vi·∫øt
    function commentPost(postId) {
      const comment = prompt("Nh·∫≠p b√¨nh lu·∫≠n:");
      if (!comment) return;

      const username = sessionStorage.getItem("loggedInUser");
      const postRef = doc(db, "posts", postId);

      updateDoc(postRef, {
        comments: arrayUnion({ username, text: comment })
      });
    }

    // Chia s·∫ª b√†i vi·∫øt
    function sharePost(content) {
      navigator.clipboard.writeText(content);
      alert("ƒê√£ sao ch√©p n·ªôi dung b√†i vi·∫øt!");
    }

    window.onload = function() {
      const loggedInUser = sessionStorage.getItem("loggedInUser");
      if (loggedInUser) showApp(loggedInUser);
    };
  </script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #f0f2f5; color: #333; }
    .auth-container, .app-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
    .auth-box, .post-box, .post { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 10px; width: 90%; max-width: 400px; }
    .auth-box input, .auth-box button, .post-box textarea, .post-box button { width: 100%; padding: 10px; margin: 5px 0; border-radius: 4px; }
    .auth-box button, .post-box button { background: #4267B2; color: white; cursor: pointer; }
    .auth-box .google-btn { background: #db4437; }
  </style>
</head>
<body>
  <div id="auth-container" class="auth-container">
    <div id="login-box" class="auth-box">
      <input type="text" id="login-username" placeholder="Email">
      <input type="password" id="login-password" placeholder="M·∫≠t kh·∫©u">
      <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
      <button class="google-btn" onclick="loginWithGoogle()">Google</button>
      <p><a href="#" onclick="showRegister()">ƒêƒÉng k√Ω</a></p>
    </div>
  </div>

  <div id="app-container" class="app-container" style="display: none;">
    <button onclick="logout()">ƒêƒÉng xu·∫•t</button>
    <div class="post-box">
      <textarea id="post-content"></textarea>
      <button onclick="addPost()">ƒêƒÉng b√†i</button>
    </div>
    <div id="posts"></div>
  </div>
</body>
  </html>
